# SKB.CleanWebApi ðŸš€

## Project Overview
SKB.CleanWebApi is a template for building .NET Web APIs using Clean Architecture principles. It implements:
- **Presentation Layer** (API endpoints, middleware)
- **Application Layer** (CQRS, MediatR handlers, metrics)
- **Domain Layer** (business logic, domain models)
- **Infrastructure Layer** (messaging/event bus, integrations)

Key patterns: **CQRS**, **Dependency Injection**, **Domain-Driven Design**.

---

## Features
- **Sample Weather Forecast API** (`/weatherforecast`)
- **CQRS** via MediatR
- **Metrics** and **Tracing** (OpenTelemetry, Prometheus, Grafana)
- **Centralized Exception Handling** (with AI chat service integration for error analysis)
- **Event Bus** (MassTransit, RabbitMQ)
- **Event-Driven Chat Service** (LLM-powered operational analytics)
- **Dockerized** with full local observability stack (Loki, Prometheus, Jaeger, Grafana, Fluent Bit)
- **Architecture tests** to enforce Clean Architecture boundaries

---

## Event-Driven Chat Service (LLM Analytics)

This template integrates an event-driven chat service that leverages a Large Language Model (LLM) for operational analytics and error analysis. When exceptions or notable events occur, the system publishes them to the event bus, where the chat service consumes these events and provides insightful, AI-powered analysis and recommendations.

- **Purpose:**
  - Automated error analysis and operational insights using LLMs.
  - Enhances observability and troubleshooting by generating human-readable explanations for complex issues.
- **How it works:**
  - Errors and operational events are published to the event bus (RabbitMQ).
  - The chat service consumes these events and uses an LLM to analyze and summarize them.
  - Results can be logged, displayed in dashboards, or used for further automation.
- **Reference:**
  - For more details, see the [ChatService.EventConsumers README](https://github.com/saapo-ka-baadshah/SKB.App.ChatService/blob/main/src/ChatService.EventConsumers/README.md).

---

## Getting Started

### Prerequisites
- [.NET 9 SDK](https://dotnet.microsoft.com/download)
- [Docker](https://www.docker.com/)
- GitHub Personal Access Token (PAT) with package feed permissions

### Environment Setup
1. **Create `.env` file** (or run the environment creation script, see below):
   ```
   GITHUB_USERNAME=YOUR_GITHUB_NAMESPACE
   GITHUB_PACKAGES_FEED_PAT=YOUR_GITHUB_PAT_WITH_FEED_RW_PERMISSION
   ```
2. **Generate random passwords** for Grafana and RabbitMQ (auto-generated by the setup script).

#### Environment Creation Script

To simplify and secure the setup of required environment variables, use the provided script:

```bash
cd deployers/docker-deploy
./0_create_env.sh
```

**What this script does:**
- Prompts you for your GitHub username and Personal Access Token (PAT) if not already set.
- Validates your GitHub PAT by making a test API call.
- Saves your credentials to a `.env` file in the correct format.
- Automatically generates strong random passwords for Grafana and RabbitMQ and adds them to `.env`.
- Ensures the project root is set in the environment file.
- Reminds you to keep `.env` out of version control for security.

**Result:**
- A fully populated `.env` file with all required secrets and configuration for local development and Docker builds.

---

## Build & Run

### Build Docker Image
```bash
./docker-build.sh -t clean-web-api:latest
```

### Start Local Environment
```bash
cd deployers/docker-deploy
./1_start_dev.sh
```

### Stop Environment
```bash
./3_stop.sh
```

---

## API Usage

### Sample Endpoint

- **GET** `/weatherforecast`
  - Returns: Array of weather forecast data (date, temperature, summary)
  - Example response:
    ```json
    [
      {
        "date": "2024-06-11",
        "temperatureC": 25,
        "summary": "Warm",
        "temperatureF": 77
      }
    ]
    ```

- **Swagger UI**: Available at `/swagger` (in non-production)

---

## Architecture

- **Presentation Layer**: ASP.NET Core, endpoints, middleware
- **Application Layer**: CQRS handlers, metrics, dependency injection
- **Domain Layer**: Business logic, domain models
- **Infrastructure Layer**: Messaging (MassTransit, RabbitMQ), integrations

See [Theory Information](./README.theory.md) for in-depth architectural details.

---

## Observability Stack

- **Prometheus**: Metrics scraping (`localhost:9090`)
- **Grafana**: Dashboards (`localhost:3000`)
- **Loki**: Log aggregation (`localhost:3100`)
- **Jaeger**: Distributed tracing (`localhost:16686`)
- **Fluent Bit**: Log shipping
- **OpenTelemetry Collector**: Telemetry pipeline

---

## Testing

- **Architecture Tests**: Enforce Clean Architecture boundaries (see `tests/Architecture.Tests/`)
- **Run tests**:
  ```bash
  dotnet test
  ```

---

## Extending the Template

- Add new features by creating new CQRS handlers in the Application layer.
- Add new endpoints in the Presentation layer.
- Add new domain logic in the Domain layer.
- Integrate new infrastructure (e.g., messaging, databases) in the Infrastructure layer.

---

## Troubleshooting

- Ensure `.env` is present and correctly configured.
- Check Docker containersâ€™ health via `docker ps` and logs.
- For build issues, verify GitHub PAT and username.
- For observability, access Grafana, Prometheus, Jaeger, and Loki via their respective ports.

---

## References

- [Clean Architecture](https://8thlight.com/blog/uncle-bob/2012/08/13/the-clean-architecture.html)
- [CQRS Pattern](https://martinfowler.com/bliki/CQRS.html)
- [MediatR](https://github.com/jbogard/MediatR)
- [MassTransit](https://masstransit-project.com/)
- [OpenTelemetry](https://opentelemetry.io/)
- [ChatService.EventConsumers README](https://github.com/saapo-ka-baadshah/SKB.App.ChatService/blob/main/src/ChatService.EventConsumers/README.md)

---

For more theory and design details, see [README.theory.md](./README.theory.md)
